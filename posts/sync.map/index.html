<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Sync.Map :: Terminal</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="sync.Map" />
<meta name="keywords" content=", " />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://jujunwang.github.io/posts/sync.map/" />




<link rel="stylesheet" href="https://jujunwang.github.io/assets/style.css">

  <link rel="stylesheet" href="https://jujunwang.github.io/assets/green.css">






<link rel="apple-touch-icon" href="https://jujunwang.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://jujunwang.github.io/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Sync.Map">
<meta property="og:description" content="sync.Map" />
<meta property="og:url" content="https://jujunwang.github.io/posts/sync.map/" />
<meta property="og:site_name" content="Terminal" />

  <meta property="og:image" content="https://jujunwang.github.io">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-06-28 20:53:26 &#43;0800 CST" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    JujunWang&#39;s Blog
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="https://github.com/jujunwang?tab=repositories">Github</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="https://github.com/jujunwang?tab=repositories">Github</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://jujunwang.github.io/posts/sync.map/">Sync.Map</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-06-28
        
      </span>
    
    
    
  </div>

  
  


  

  <div class="post-content"><div>
        <h1 id="syncmap">sync.Map<a href="#syncmap" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<hr>
<p>众所周知，golang的map不是线程安全的（只读是线程安全的，同时写线程不安全），所以官方在go的1.9版本推出了sync.Map。</p>
<blockquote>
<p><code>sync.map</code> 是线程安全的，读取，插入，删除也都保持着常数级的时间复杂度。
<code>sync.map</code> 的零值是有效的，并且零值是一个空的 map。在第一次使用之后，不允许被拷贝.</p>
</blockquote>
<hr>
<h2 id="1-如何使用">1. 如何使用<a href="#1-如何使用" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">m</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Map</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1. 写入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#e6db74">&#34;zhao&#34;</span>, <span style="color:#ae81ff">18</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#e6db74">&#34;qian&#34;</span>, <span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Store</span>(<span style="color:#e6db74">&#34;li&#34;</span>, <span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2. 读取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">age1</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#e6db74">&#34;zhao&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">age1</span>.(<span style="color:#66d9ef">int</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 3. 遍历
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Range</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">key</span>.(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">age</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">value</span>.(<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">age</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 4. 删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#e6db74">&#34;zhao&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">age2</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#e6db74">&#34;zhao&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">age2</span>, <span style="color:#a6e22e">ok</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 5. 读取并删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">age4</span>, <span style="color:#a6e22e">loaded</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">LoadAndDelete</span>(<span style="color:#e6db74">&#34;li&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">age4</span>, <span style="color:#a6e22e">loaded</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 6. 读取或写入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">age3</span>, <span style="color:#a6e22e">flag</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">LoadOrStore</span>(<span style="color:#e6db74">&#34;qian&#34;</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">age3</span>, <span style="color:#a6e22e">flag</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="2-原理">2. 原理<a href="#2-原理" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>sync.Map</code>主要采取“空间换时间”的策略，来支持并发读写，并且相对于加锁来说，降低了对性能的影响。具体方式是增加两个冗余的数据结构，分别是：read和dirty。</p>
<p>Sync.Map的核心数据结构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Map</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mu</span> <span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Value</span> <span style="color:#75715e">// readOnly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dirty</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">misses</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center">说明</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mu</td>
<td style="text-align:center">Mutex</td>
<td style="text-align:center">加锁作用。保护后文的dirty字段</td>
</tr>
<tr>
<td style="text-align:center">read</td>
<td style="text-align:center">atomic.Value</td>
<td style="text-align:center">存读的数据。因为是atomic.Value类型，只读，所以并发是安全的。实际存的是readOnly的数据结构。</td>
</tr>
<tr>
<td style="text-align:center">misses</td>
<td style="text-align:center">int</td>
<td style="text-align:center">计数作用。每次从read中读失败，则计数+1。</td>
</tr>
<tr>
<td style="text-align:center">dirty</td>
<td style="text-align:center">map[interface{}]*entry</td>
<td style="text-align:center">包含最新写入的数据。当misses计数达到一定值，将其赋值给read。</td>
</tr>
</tbody>
</table>
<p>其是专门为 append-only 场景设计的，也就是适合读多写少的场景。这是他的优点之一。</p>
<p>若出现写多/并发多的场景，会导致 read map 缓存失效，需要加锁，冲突增加，性能急剧下降。这是他的重大缺点。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1d7f700587ced~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="01"></p>
<p>这里有必要简单描述一下，大概的逻辑，</p>
<p>readOnly的数据结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">readOnly</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>  <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">amended</span> <span style="color:#66d9ef">bool</span> 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://jujunwang.github.io/posts/%E7%A8%8B%E5%BA%8F%E7%9A%84%E9%93%BE%E6%8E%A5%E8%BF%87%E7%A8%8B/">
                <span class="button__icon">←</span>
                <span class="button__text">程序的链接过程</span>
            </a>
        </span>
        
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://jujunwang.github.io/assets/main.js"></script>
<script src="https://jujunwang.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
